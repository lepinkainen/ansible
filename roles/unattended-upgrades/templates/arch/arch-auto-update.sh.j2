#!/bin/bash
# Auto-update script for Arch Linux
# Generated by Ansible

set -euo pipefail

LOG_FILE="/var/log/arch-auto-update.log"
REBOOT_FLAG="/var/run/reboot-required"

# Function to log messages
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

# Function to send notification email
send_notification() {
    local subject="$1"
    local body="$2"
    
    if command -v msmtp >/dev/null 2>&1; then
        {
            echo "Subject: [$HOSTNAME] $subject"
            echo "To: root"
            echo ""
            echo "$body"
        } | msmtp root
    fi
}

log "Starting automatic system update"

# Update package databases
log "Updating package databases..."
if ! pacman -Sy --noconfirm; then
    log "ERROR: Failed to update package databases"
    send_notification "Auto-update failed" "Failed to update package databases on $HOSTNAME"
    exit 1
fi

# Check for available updates
UPDATES=$(pacman -Qu 2>/dev/null | wc -l)
log "Found $UPDATES packages to update"

if [ "$UPDATES" -eq 0 ]; then
    log "No updates available"
    exit 0
fi

# Perform system upgrade
log "Upgrading system..."
if pacman -Su --noconfirm; then
    log "System upgrade completed successfully"
    
    # Check if reboot is required (kernel or systemd updates)
    if pacman -Q linux | grep -q "$(uname -r)" || pacman -Qq | grep -E '^(systemd|glibc)$' >/dev/null; then
        log "Reboot may be required"
        touch "$REBOOT_FLAG"
        
        # Schedule reboot if configured
        {% if auto_reboot_config.automatic_reboot | default(true) %}
        log "Scheduling reboot for {{ auto_reboot_config.automatic_reboot_time | default('02:00') }}"
        echo "shutdown -r {{ auto_reboot_config.automatic_reboot_time | default('02:00') }} 'Automatic reboot after system update'" | at now
        {% endif %}
    fi
    
    send_notification "Auto-update completed" "Successfully updated $UPDATES packages on $HOSTNAME"
else
    log "ERROR: System upgrade failed"
    send_notification "Auto-update failed" "System upgrade failed on $HOSTNAME"
    exit 1
fi

log "Auto-update process completed"